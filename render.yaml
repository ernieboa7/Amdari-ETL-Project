services:
  - type: web
    name: amdari-etl-airflow           # you can change this name if you like
    env: docker
    plan: starter                      # or "free" / whatever plan you use
    autoDeploy: true
    dockerfilePath: ./Dockerfile

    startCommand: >
      bash -c "
      export AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=\"postgresql+psycopg2://${NEON_DB_USER}:${NEON_DB_PASSWORD}@${NEON_DB_HOST}:${NEON_DB_PORT}/${NEON_DB_NAME}?sslmode=${NEON_DB_SSLMODE}\" &&
      airflow db init &&
      airflow users create
        --username \"${_AIRFLOW_WWW_USER_USERNAME:-airflow}\"
        --password \"${_AIRFLOW_WWW_USER_PASSWORD:-airflow}\"
        --firstname Admin
        --lastname User
        --role Admin
        --email admin@example.com || true &&
      airflow webserver --port \$PORT
      "

    envVars:
      # Airflow core settings
      - key: AIRFLOW__CORE__FERNET_KEY
        sync: false
      - key: AIRFLOW__CORE__LOAD_EXAMPLES
        value: "False"
      - key: AIRFLOW__WEBSERVER__RBAC
        value: "True"

      # Web UI user credentials (password kept in Render as secret)
      - key: _AIRFLOW_WWW_USER_USERNAME
        value: airflow
      - key: _AIRFLOW_WWW_USER_PASSWORD
        sync: false

      # Neon connection pieces â€“ these should already be set in Render
      - key: NEON_DB_HOST
        sync: false
      - key: NEON_DB_PORT
        value: "5432"
      - key: NEON_DB_NAME
        sync: false
      - key: NEON_DB_USER
        sync: false
      - key: NEON_DB_PASSWORD
        sync: false
      - key: NEON_DB_SSLMODE
        value: "require"
