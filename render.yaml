services:
  - type: web
    name: amdari-etl-airflow
    runtime: docker
    plan: free
    autoDeploy: true
    dockerfilePath: ./Dockerfile

    # Just call your start script
    dockerCommand: /opt/airflow/render-start.sh

    envVars:
      # Airflow core settings
      - key: AIRFLOW__CORE__FERNET_KEY
        sync: false              # set in Render dashboard (secret)
      - key: AIRFLOW__CORE__LOAD_EXAMPLES
        value: "False"
      - key: AIRFLOW__WEBSERVER__RBAC
        value: "True"

      # Light concurrency (also defaulted in render-start.sh, but explicit here is fine)
      - key: AIRFLOW__WEBSERVER__WORKERS
        value: "1"
      - key: AIRFLOW__CORE__PARALLELISM
        value: "2"
      - key: AIRFLOW__CORE__DAG_CONCURRENCY
        value: "2"
      - key: AIRFLOW__CORE__MAX_ACTIVE_RUNS_PER_DAG
        value: "1"

      # Web UI user credentials
      - key: _AIRFLOW_WWW_USER_USERNAME
        value: airflow
      - key: _AIRFLOW_WWW_USER_PASSWORD
        sync: false              # secret in Render

      # Neon connection info (secrets set in Render dashboard)
      - key: NEON_DB_HOST
        sync: false
      - key: NEON_DB_PORT
        value: "5432"
      - key: NEON_DB_NAME
        sync: false
      - key: NEON_DB_USER
        sync: false
      - key: NEON_DB_PASSWORD
        sync: false
      - key: NEON_DB_SSLMODE
        value: "require"
